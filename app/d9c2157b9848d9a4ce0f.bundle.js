"use strict";(self.webpackChunkgameflip_market=self.webpackChunkgameflip_market||[]).push([[492],{30492:(e,t,i)=>{i.r(t),i.d(t,{default:()=>w}),i(44431);var s=i(67294),o=i(84766),a=i(47675),l=i(42741),n=i(46858),r=i(95835),c=i(49280),h=i(74685),d=i(4475),m=i(40654),p=i(64927),g=i(21397),u=i(25315),_=(i(90135),i(94643)),b=(i(17515),i(57097)),f=i(47936),x=(i(24741),i(27721)),E=i(1055),k=i(78314),v=i(96655);class w extends s.Component{constructor(e,t){super(e,t)}componentDidMount(){n.Z.checkLogin()&&n.Z.setDocumentTitle((0,E._)("Purchases"))}render(){if(!n.Z.isLoggedIn)return!1;let e=n.Z.parseQuery(this.props.location.search);return s.createElement("div",{id:"purchases",className:"screen container"},s.createElement("h1",null,(0,E._)("Purchases")),s.createElement("div",{className:"inner-content"},s.createElement(y,{type:"exchange",query:e})))}}class y extends s.Component{constructor(e,t){super(e,t),this.state=this.resetState()}componentDidMount(){this.loadExchanges(this.props)}componentDidUpdate(e,t){JSON.stringify(this.props.query)!==JSON.stringify(e.query)&&(this.setState(this.resetState(this.props)),this.loadExchanges(this.props))}resetState(e){return e=e||this.props,this.type=e.type,this.checked_item_ids={},this.checked_all=!1,{items:[],next_page:null}}filterItems(e,t){this.setState(this.resetState(this.props));let i=t?{}:n.Z.pagingQuery(this.props.query||{},25);i=o.Util.merge(i,e),n.Z.transitionTo("purchases",{},i)}loadExchanges(e){let t=n.Z.pagingQuery(e.query||{},25);t.kind=[v.Iox,v.Bxu,v.n$X].join(),l.Z.searchExchanges(v._Kh,t,((e,i)=>{e.found;let s=e.exchanges||[],a=[],l={},n=x.Z.exchanges;s.map((e=>{let t=n[e.id];t&&(o.Log.debug(t,"indexing_exchange"),t.version>e.version?e=t:x.Z.deleteExchange(e.id)),l[e.id]=!0,a.push(e)})),1==t.page&&x.Z.getActiveExchanges().map((e=>{l[e.id]||(o.Log.debug(e,"active_indexing_exchange"),a.unshift(e))})),this.setState({items:a,next_page:i})}),(e=>{o.Log.error(e)}))}reloadExchange(e){l.Z.getExchange(e.id,(t=>{if(e.buyer!=t.buyer)return;let i=this.state.items;for(let e=0;e<=i.length;e++)if(i[e]&&i[e].id==t.id){i[e]=t,o.Log.debug(t,"Exchange reloaded");break}this.setState({items:i})}))}loadMore(e){e.preventDefault(),this.loadExchanges(this.props)}onSelect(e,t){t.target.checked?this.checked_item_ids[e]=!0:(delete this.checked_item_ids[e],this.checked_all=!1),this.forceUpdate()}onSelectAll(e){this.checked_all=e.target.checked,this.state.items.map((e=>{this.checked_all?this.checked_item_ids[e.id]=!0:delete this.checked_item_ids[e.id]})),this.forceUpdate()}onClickActionButton(e,t){0!=Object.keys(this.checked_item_ids).length&&"bulk_retrieve"===e&&this.bulkRetrieve()}bulkRetrieve(){let e=k.Z.steam_trade_url;if(!e)return;let t=()=>{n.Z.showDialog({title:(0,E._)("Retrieve items from Bot"),message:(0,E._)("We're sending trade offers to retrieve your items. Please complete them in your Steam account. Once you successfully traded with Gameflip Steam bot, please confirm below."),ok:{label:(0,E._)("I've completed all Bot Trades"),callback:e=>{n.Z.hideDialog(),this.state.items.map((e=>{e.escrow_status==v.FKl&&(this.checked_item_ids[e.id]=!0)})),this.processAction(i,a)}},cancel:{label:(0,E._)("Cancel"),callback:e=>{n.Z.hideDialog()}}})},i="bulk_retrieve",s=!1,a=r=>{var c,h;s||r.escrow_status!=v.X8_||(t(),s=!0),h=()=>{this.processAction(i,a)},(c=r).escrow_status==v.X8_?l.Z.postSteamEscrowDeliver(c.id,e,(e=>{o.Log.debug(e,"postSteamEscrowDeliver"),c.escrow_status=v.FKl,x.Z.setExchange(c),h()}),(e=>{n.Z.showErrorDialog(e)})):c.escrow_status==v.FKl&&l.Z.putSteamEscrowDeliver(c.id,(e=>{o.Log.debug(e,"putSteamEscrowDeliver"),e.status==v.gzR?(c.status=v.I2W,c.escrow_status=v.gzR):e.status==v.FKl?t():(n.Z.showErrorDialog("There is a bot trade offer which has been cancelled. Please retrieve it again."),c.escrow_status=v.X8_),x.Z.setExchange(c),h()}),(e=>{h()}))};this.processAction(i,a)}checkedItem(e){let t=this.state.items,i=null;for(let e in this.checked_item_ids){for(let s in t){let o=t[s];if(o.id==e){i=n.Z.clone(o),this.setState({items:t});break}}delete this.checked_item_ids[e];break}return i}processAction(e,t){o.Log.debug(e,"Processing action");let i=this.checkedItem(e);i?t(i):(this.checked_all&&(this.checked_all=!1),this.setState({items:[],next_page:null},(()=>{this.loadExchanges(this.props)})))}render(){let{query:e}=this.props,{items:t,next_page:i}=this.state,o=!1,a=e&&"settled,pending"==e.status&&e.handling_status==v.oAF&&"true"===e.digital&&"true"===e.escrow,l=t.map(((e,t)=>{let i=this.checked_item_ids[e.id];return i&&(o=!0),s.createElement(Z,{type:this.type,selectable:a,item:e,onSelect:this.onSelect.bind(this,e.id),checked:i,key:e.id})})),r=n.Z.pagingQuery(this.props.query||{},25),d=s.createElement(h.Z,{to:"purchases",query:r,next_url:i,scrollToTop:!0}),m={onClickActionButton:this.onClickActionButton.bind(this),onSelectAll:this.onSelectAll.bind(this),filterItems:this.filterItems.bind(this)};return s.createElement("div",{className:"item-list"},s.createElement(c.Z,{position:"header",type:"exchange",role:v._Kh,config:null,callbacks:m,checked_one:o,checked_all:this.checked_all,query:e}),l,s.createElement(c.Z,{position:"footer",type:"exchange",role:v._Kh,config:null,callbacks:m,checked_one:o,checked_all:this.checked_all,query:e}),d,s.createElement(S,{onRefresh:this.reloadExchange.bind(this)}))}}class Z extends s.Component{constructor(e,t){super(e,t),this.state={item:this.prepare(this.props.item)}}componentDidUpdate(e,t){this.props.item&&e.item&&this.props.item.id!==e.item.id&&this.setState({item:this.prepare(this.props.item)})}componentDidMount(){this.handleTooltips();let e=this.state.item||this.props.item;e&&e.collectible_item_id?this.loadCollectibleItem(e.collectible_item_id):e&&e.listing_id&&this.loadListing(e.listing_id)}componentDidUpdate(){this.handleTooltips()}loadListing(e){o.Log.debug(e,"Loading listing"),l.Z.getListing(e,(e=>{let{nft_metadata:t}=e;e.collectible_item_id||t&&t.token_id?(this.setState({listing:e}),this.loadCollectibleItem(e.collectible_item_id)):(o.Log.info((0,E._)("Listing is not NFT")),this.setState({listing:null}))}),(e=>{o.Log.error(e,"Error loading listing"),this.setState({listing:null})}))}loadCollectibleItem(e){l.Z.getCollectibleItem(e,(e=>{this.setState({collectibleItem:e})}),(e=>{o.Log.error(e,"Got error"),this.setState({collectibleItem:null})}))}prepare(e){let t=n.Z.clone(e);t.cover_photo=e.kind===v.n$X||e.category==v.xmu&&"gameflip"==e.platform?"/img/app/icon_category_orange_blockchain.png":a.Z.apiEndpoint+"listing/"+e.listing_id+"/photo/cover_photo",t.price=e.bn_price||e.price?s.createElement(p.Z,{money:e.bn_price||e.price,currency:e.accept_currency}):"",t.created=(0,E._)("Bought")+" "+n.Z.timePassed(e.created),t.link_to="exchange_buyer",t.link_params={id:e.id};let i=e.status;return v.rlS==i?e.hold_status?i=e.hold_status:v.IfI==e.handling_status?i=v.PGQ:v.jJH==e.handling_status&&(i=v.Xp3):v.V5K==i?e.hold_status?i=e.hold_status:e.buyer_rated&&(i=v.I2W):v.VxZ==i||v.s5d==i||v.nmn==i?i=v.unP:v.WWs==i&&t.hold_status&&(i=t.hold_status),t.status=i,t}onClickCheckbox(e){if(e.stopPropagation(),n.Z.isBrowser&&n.Z.isFirefox){let t=$(e.target),i=t.closest("a.item-detail");i.data("href",i.attr("href")).removeAttr("href"),t.on("mouseleave",(()=>{i.attr("href",i.data("href"))}))}this.props.onSelect(e)}onClickToolButton(e,t){t.preventDefault(),this.hideTooltip(e);let i=n.Z.clone(this.props.item);"resell"===e?this.resellItem():b.Z.showDialog(e,i)}resellItem(){l.Z.getListing(this.props.item.listing_id,(e=>{o.Log.debug(e,"resellItem: item"),e.status=v.W8z,delete e.id,delete e.owner,delete e.cover_photo,delete e.commission,delete e.digital_fee,delete e.expiration,delete e.comment,delete e.exchange_id,delete e.created,delete e.updated,delete e.version,f.Z.reset(),f.Z.postItem(e)}),(e=>{n.Z.showErrorDialog(e)}))}handleTooltips(){if(n.Z.isBrowser&&this.state.item&&this.state.item.id){let e=$(".item-id-"+this.state.item.id+" .tool-btn");e.length>0&&e.tooltip()}}hideTooltip(e){if(n.Z.isBrowser&&this.state.item&&this.state.item.id&&e){let t=$(".item-id-"+this.state.item.id+" .tool-btn.tool-"+e);t.length>0&&t.tooltip("hide")}}get exchangeStates(){return{pending:{ribbon:"icon_ribbon_in-progress.png",text:(0,E._)("Processing"),color:"#ff8200"},hold_buy:{ribbon:"icon_ribbon_in-progress.png",text:(0,E._)("Under Review"),color:"#a94442"},hold_challenge:{ribbon:"icon_ribbon_in-progress.png",text:(0,E._)("Payment Verification Required"),color:"#a94442"},hold_dispute:{ribbon:"icon_ribbon_in-progress.png",text:(0,E._)("Under Dispute"),color:"#a94442"},settled:{ribbon:"icon_ribbon_in-progress.png",text:(0,E._)("Wait for Delivery"),color:"#ff8200"},shipping:{ribbon:"icon_ribbon_in-progress.png",text:(0,E._)("Wait for Seller"),color:"#ff8200"},shipped:{ribbon:"icon_ribbon_in-progress.png",text:(0,E._)("Review & Complete Transaction"),color:"#ff8200"},received:{ribbon:"icon_ribbon_in-progress.png",text:(0,E._)("Review & Complete Transaction"),color:"#ff8200"},pending_completion:{ribbon:"icon_ribbon_completed.png",text:(0,E._)("Transaction Complete"),color:"#0001C5"},complete:{ribbon:"icon_ribbon_completed.png",text:(0,E._)("Transaction Completed"),color:"#0001C5"},cancelled:{ribbon:"icon_ribbon_cancelled.png",text:(0,E._)("Transaction Cancelled"),color:"#3E4857"}}}render(){let{item:e,listing:t,collectibleItem:i}=this.state,a=this.exchangeStates[e.status]||this.exchangeStates[v.rlS],l=e.status==v.rlS&&e.escrow_status;e.ribbon="/img/app/"+a.ribbon,e.info={text:l?(0,E._)("Retrieve Your Item"):a.text,style:{color:a.color}};let n={rate:{icon:"thumbs-up",tip:(0,E._)("Rate Seller")},view:{icon:"eye",tip:(0,E._)("Quick View")},message:{icon:"envelope",tip:(0,E._)("Message Seller")},resell:{icon:"money-bill",tip:(0,E._)("Resell this Item")}},c=["rate","view","message","resell"].map((t=>{let i=n[t];switch(t){case"resell":if(e.kind!=v.Iox||e.digital||e.status!=v.I2W)return!1;break;case"rate":if(e.buyer_rated||e.escrow_status||e.status!=v.I2W)return!1;{let t=e.rate_by||0;t||(t=(e.completed||0)+1728e6);let i=new Date(t).getTime();if((new Date).getTime()>=i)return!1}}let o="message"==t&&e.message?s.createElement("span",{className:"message-count float-left"},e.message):"";return s.createElement("button",{key:t,className:"btn btn-outline-secondary tool-btn tool-"+t,title:i.tip,onClick:this.onClickToolButton.bind(this,t)},o,s.createElement("span",{className:"fa fa-"+i.icon,"aria-hidden":"true"}))})),h=this.props.selectable||!1,d=null;return d=i?s.createElement(g.Z,{item:i,show:"video"}):s.createElement(r.Z,{className:"img-fluid bg_3d",src:e.cover_photo,dim:320}),s.createElement("div",{className:"row item-detail item-id-"+e.id},s.createElement("div",{className:"d-none d-md-inline-block col-md-1 select text-center"},h?s.createElement("input",{type:"checkbox",onClick:this.onClickCheckbox.bind(this),checked:this.props.checked}):""),s.createElement("div",{className:"col-3 col-md-1 photo"},s.createElement("div",{className:"square-responsive"},s.createElement(o.Link,{to:e.link_to,params:e.link_params},s.createElement("img",{style:{position:"absolute",marginTop:"-4%",marginBottom:"-4%",width:"50%",zIndex:"10"},src:e.ribbon}),d))),s.createElement("div",{className:"col-9 col-md-7 info"},s.createElement("div",{className:"row"},s.createElement("h4",{className:"col-12 name"},s.createElement(o.Link,{to:e.link_to,params:e.link_params},e.name))),s.createElement("div",{className:"row"},s.createElement("div",{className:"col-12 col-md-5"},s.createElement("div",{style:e.info.style},e.info.text),s.createElement("span",{className:"h5 price"},e.price),s.createElement("div",{className:"d-none d-md-block date text-muted"},e.created)),s.createElement("div",{className:"col-12 col-md-7"},s.createElement(D,{id:e.seller})))),s.createElement("div",{className:"col-12 col-md-3 buttons"},s.createElement("div",{className:"row no-gutters"},s.createElement("div",{className:"col-5"},s.createElement("p",{className:"d-md-none date text-muted"},e.created)),s.createElement("div",{className:"col-7 col-md-12 text-right"},c))))}}class S extends s.Component{constructor(e,t){super(e,t),this.state={tool:"",item:null},this._onDialog=this._onDialog.bind(this),this.should_show=!1}componentDidMount(){b.Z.onShowDialog(this._onDialog)}componentDidUpdate(){this.should_show&&(this.should_show=!1,this.show())}componentWillUnmount(){b.Z.offShowDialog(this._onDialog)}_onDialog(e,t){this.should_show=!0,this.setState({tool:e,item:t})}show(){$("#purchases-quickview-dialog").is(":visible")||$("#purchases-quickview-dialog").modal("show")}hide(){$("#purchases-quickview-dialog").modal("hide")}rate(e){let{tool:t,item:i}=this.state;"rate"==t&&i&&i.id&&(e.exchange_id=i.id,l.Z.postRating(e,(e=>{this.props.onRefresh&&this.props.onRefresh(i),this.hide()}),(e=>{this.hide(),n.Z.showErrorDialog(e)})))}render(){let{tool:e,item:t}=this.state;switch(e){case"view":return this.renderExchange(t);case"message":return this.renderMessages(t);case"rate":return this.renderRating(t)}return!1}renderExchange(e){let t=(0,E._)("Order"),i=e?t+": "+e.name:t;return s.createElement(o.Dialog,{id:"purchases-quickview-dialog",className:"fade",title:i,size:"xl",content:s.createElement("div",{className:"container-fluid"},e?s.createElement(d.default,{exchange_id:e.id,quickview:!0}):"")})}renderMessages(e){let t=(0,E._)("Messages")+(e?": "+e.name:""),i="";if(e){let t=[v.WWs,v.s5d,v.nmn,v.h_V,v.I2W,v.unP,v.VxZ].indexOf(e.status)>=0;i=s.createElement(m.Z,{exchange_id:e.id,readonly:t,quickview:!0})}return s.createElement(o.Dialog,{id:"purchases-quickview-dialog",className:"fade",title:t,content:s.createElement("div",{className:"container-fluid"},i)})}renderRating(e){let t=s.createElement("span",null,(0,E._)("Rate Your Experience"),": ",e.name),i=(0,E._)("My experience with this Seller was");return s.createElement(o.Dialog,{id:"purchases-quickview-dialog",className:"fade",title:t,size:"med",content:s.createElement("div",{className:"container-fluid"},s.createElement(u.Z,{heading:i,onPostRating:this.rate.bind(this)}))})}}class D extends s.Component{constructor(e,t){super(e,t),this.state={profile:{}}}componentDidMount(){this.props.id&&!this.props.profile&&this.loadProfile(this.props.id)}componentDidUpdate(e,t){this.props.id&&this.props.id!==e.id&&!this.props.profile&&this.loadProfile(this.props.id)}loadProfile(e){l.Z.getProfile(e,(e=>{this.setState({profile:e})}),(e=>{}))}render(){let e=this.props.profile||this.state.profile,t=e.owner||this.props.id;return s.createElement("div",{className:"row mb-3"},s.createElement("div",{className:"col-12"},s.createElement("span",null,(0,E._)("Sold by"),"Â "),s.createElement(_.Z,{className:"d-none d-md-inline-block",profile:e}),s.createElement(o.Link,{to:"profile",params:{id:t,name:n.Z.slug(e.display_name)}},s.createElement("span",{className:"overflow-hidden"},e.display_name))))}}},27721:(e,t,i)=>{i.d(t,{Z:()=>a});var s=i(84766),o=(i(46858),i(96655));const a=new class{constructor(){this._exchanges=s.Storage.getObject(o.cL1)||{}}storeExchanges(){s.Storage.setObject(o.cL1,this._exchanges)}get cache_expire(){return(new Date).getTime()+18e4}get exchanges(){return this._exchanges}setExchange(e){e.cache_expire=this.cache_expire,this._exchanges[e.id]=e,this.storeExchanges()}deleteExchange(e){delete this._exchanges[e],this.storeExchanges()}getExchangesByStatus(e){let t=(new Date).getTime(),i=!1,o=[];for(let s in this._exchanges){let a=this._exchanges[s];a.cache_expire<t?(delete this._exchanges[s],i=!0):(!e||e.indexOf(a.status)>=0)&&o.push(a)}return s.Log.debug(o,"IndexingExchangesStore.getExchangesByStatus: exchanges"),i&&this.storeExchanges(),o}getActiveExchanges(){return this.getExchangesByStatus()}}}}]);